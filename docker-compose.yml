version: '3.8'

services:
  # Database for Dotnet API (Students) - Using containerized SQL Server 2022
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: sqlserver
    restart: always
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=Password123!
    ports:
      - "1435:1433" # Changed to 1435 to avoid conflict with local MSSQL
    networks:
      - app-network

  # Initialization service for SQL Server
  init-mssql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: init-mssql
    depends_on:
      - sqlserver
    volumes:
      - ./database-scripts/mssql_student.sql:/init_student.sql
      - ./database-scripts/mssql_users.sql:/init_users.sql
    command: >
      /bin/bash -c "
      echo 'Waiting for SQL Server to be up...';
      sleep 30;
      /opt/mssql-tools18/bin/sqlcmd -C -S sqlserver -U sa -P Password123! -Q 'CREATE DATABASE StudentDB';
      /opt/mssql-tools18/bin/sqlcmd -C -S sqlserver -U sa -P Password123! -d StudentDB -i /init_student.sql;
      /opt/mssql-tools18/bin/sqlcmd -C -S sqlserver -U sa -P Password123! -d StudentDB -i /init_users.sql;
      "
    networks:
      - app-network

  # Database for Spring Boot API (Courses) - Using containerized MySQL 8.0
  mysql:
    image: mysql:8.0
    container_name: mysql
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=CourseDB
    ports:
      - "3307:3306" # Changed to 3307 to avoid conflict with local MySQL
    volumes:
      - ./database-scripts/mysql_course.sql:/docker-entrypoint-initdb.d/01_course.sql
      - ./database-scripts/mysql_users.sql:/docker-entrypoint-initdb.d/02_users.sql
    networks:
      - app-network

  # Dotnet API Service
  dotnet-api:
    build:
      context: ./backend/dotnet-api
      dockerfile: Dockerfile
    container_name: dotnet-api
    restart: always
    depends_on:
      - sqlserver
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      # Using internal port 1433 for container-to-container communication
      - DB_CONNECTION_STRING=Server=sqlserver,1433;Database=StudentDB;User Id=sa;Password=Password123!;TrustServerCertificate=True;
      - JWT_SECRET=judjfiehrfijsoefhejhfjijdsnujurjef984ujrnjfdifkodksjf874yrnjferh74h
      - JWT_ISSUER=student-api
      - JWT_AUDIENCE=student-app
      - ALLOWED_ORIGINS=http://localhost:4200,http://localhost:5173
    ports:
      - "5038:8080"
    networks:
      - app-network

  # Spring Boot API Service
  springboot-api:
    build:
      context: ./backend/springboot-api
      dockerfile: Dockerfile
    container_name: springboot-api
    restart: always
    depends_on:
      - mysql
    environment:
      # Using internal port 3306 for container-to-container communication
      # Added allowPublicKeyRetrieval=true which is often needed for MySQL 8.0
      - DB_CONNECTION_STRING=jdbc:mysql://mysql:3306/CourseDB?useSSL=false&allowPublicKeyRetrieval=true
      - DB_USERNAME=root
      - DB_PASSWORD=root
      - JWT_SECRET=judjfiehrfijsoefhejhfjijdsnujurjef984ujrnjfdifkodksjf874yrnjferh74h
      - ADMIN_PASSWORD=admin123
      - ALLOWED_ORIGINS=http://localhost:4200,http://localhost:5173
    ports:
      - "8081:8080"
    networks:
      - app-network

  # Angular Frontend (Consumes Dotnet API)
  angular-app:
    build:
      context: ./frontend/angular-app
      dockerfile: Dockerfile
    container_name: angular-app
    restart: always
    ports:
      - "4200:80"
    networks:
      - app-network

  # React Frontend (Consumes Spring Boot API)
  react-app:
    build:
      context: ./frontend/react-app
      dockerfile: Dockerfile
    container_name: react-app
    restart: always
    ports:
      - "5173:80"
    networks:
      - app-network

networks:
  app-network:
    driver: bridge
